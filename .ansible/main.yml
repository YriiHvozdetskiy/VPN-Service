- name: Update web servers
  hosts: all
  remote_user: ubuntu
  vars:
    ansible_python_interpreter: /usr/bin/python3
  tasks:
    - name: Pull app changes
      git:
        repo: "git@github.com:{{ GITHUB_REPO }}.git"
        dest: "{{ APP_PATH }}"
        version: main

    - name: Copy .env file
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../.env"
        dest: "{{ APP_PATH }}/.env"

    - name: Build and start Docker containers
      community.docker.docker_compose_v2:
        project_src: "{{ APP_PATH }}"
        files:
          - compose.yml
        build: true
        pull: true
        state: present

    - name: Check if containers are running
      community.docker.docker_compose_v2:
        project_src: "{{ APP_PATH }}"
        files:
          - compose.yml
        state: present
      register: output

    - name: Display Docker Compose output
      debug:
        var: output